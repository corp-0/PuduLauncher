name: tauri-build-linux
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  build-linux:
    runs-on: ubuntu-22.04
    env:
      OPENSSL_VERSION: 3.0.16
      OPENSSL_PREFIX: ${{ github.workspace }}/.cache/openssl-install
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            squashfs-tools \
            build-essential \
            perl \
            curl \
            clang \
            zlib1g-dev

      - name: Cache OpenSSL build
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_PREFIX }}
          key: ubuntu-22.04-x64-openssl-${{ env.OPENSSL_VERSION }}-shared-v1

      - name: Build OpenSSL shared libraries
        shell: bash
        run: |
          set -euxo pipefail
          OPENSSL_VERSION="${OPENSSL_VERSION}"
          OPENSSL_PREFIX="${OPENSSL_PREFIX}"
          OPENSSL_ARCHIVE="$RUNNER_TEMP/openssl-${OPENSSL_VERSION}.tar.gz"
          OPENSSL_SRC_DIR="$RUNNER_TEMP/openssl-${OPENSSL_VERSION}"

          if [ -f "$OPENSSL_PREFIX/lib/libssl.so.3" ] && [ -f "$OPENSSL_PREFIX/lib/libcrypto.so.3" ]; then
            echo "Using cached OpenSSL build at $OPENSSL_PREFIX"
          else
            rm -rf "$OPENSSL_PREFIX" "$OPENSSL_SRC_DIR"
            curl -fsSL "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" -o "$OPENSSL_ARCHIVE"
            tar -xzf "$OPENSSL_ARCHIVE" -C "$RUNNER_TEMP"
            cd "$OPENSSL_SRC_DIR"
            ./config --prefix="$OPENSSL_PREFIX" --libdir=lib shared
            make -j"$(nproc)"
            make install_sw
          fi

          echo "OPENSSL_LIB_DIR=$OPENSSL_PREFIX/lib" >> "$GITHUB_ENV"

      - uses: ./.github/actions/tauri-build

      - name: Patch AppImage with OpenSSL libs
        shell: bash
        run: |
          set -euxo pipefail
          shopt -s nullglob

          appimages=(src-tauri/target/release/bundle/appimage/*.AppImage)
          if [ "${#appimages[@]}" -ne 1 ]; then
            echo "Expected exactly one AppImage, found ${#appimages[@]}."
            printf '%s\n' "${appimages[@]}"
            exit 1
          fi

          appimage_abs="$(realpath "${appimages[0]}")"
          workdir="$(mktemp -d)"
          verifydir="$(mktemp -d)"
          appimagetool="$RUNNER_TEMP/appimagetool-x86_64.AppImage"

          curl -fsSL "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -o "$appimagetool"
          chmod +x "$appimagetool"
          chmod +x "$appimage_abs"

          (
            cd "$workdir"
            "$appimage_abs" --appimage-extract >/dev/null
          )

          appdir="$workdir/squashfs-root"
          if [ -L "$appdir" ]; then
            appdir="$(realpath "$appdir")"
          elif [ -d "$workdir/AppDir" ]; then
            appdir="$workdir/AppDir"
          fi
          if [ ! -f "$appdir/AppRun" ]; then
            appdir="$(dirname "$(find "$workdir" -maxdepth 4 -type f -name AppRun | head -n1)")"
          fi
          test -f "$appdir/AppRun"

          openssl_dir="$appdir/shared/lib/openssl"
          mkdir -p "$openssl_dir"
          cp "$OPENSSL_LIB_DIR/libssl.so.3" "$openssl_dir/"
          cp "$OPENSSL_LIB_DIR/libcrypto.so.3" "$openssl_dir/"
          ln -sfn libssl.so.3 "$openssl_dir/libssl.so"
          ln -sfn libcrypto.so.3 "$openssl_dir/libcrypto.so"

          ARCH=x86_64 "$appimagetool" --appimage-extract-and-run "$appdir" "$workdir/patched.AppImage"
          chmod +x "$workdir/patched.AppImage"

          (
            cd "$verifydir"
            "$workdir/patched.AppImage" --appimage-extract >/dev/null
          )
          verify_appdir="$verifydir/squashfs-root"
          if [ -L "$verifydir/squashfs-root" ]; then
            verify_appdir="$(realpath "$verifydir/squashfs-root")"
          elif [ -d "$verifydir/AppDir" ]; then
            verify_appdir="$verifydir/AppDir"
          fi
          if [ ! -f "$verify_appdir/AppRun" ]; then
            verify_appdir="$(dirname "$(find "$verifydir" -maxdepth 3 -type f -name AppRun | head -n1)")"
          fi

          test -f "$verify_appdir/AppRun"
          test -f "$verify_appdir/shared/lib/openssl/libssl.so.3"
          test -f "$verify_appdir/shared/lib/openssl/libcrypto.so.3"
          test -L "$verify_appdir/shared/lib/openssl/libssl.so"
          test -L "$verify_appdir/shared/lib/openssl/libcrypto.so"

          mv "$workdir/patched.AppImage" "$appimage_abs"

          rm -rf "$workdir"
          rm -rf "$verifydir"

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: ignore

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: ignore

      - name: Upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: ignore
