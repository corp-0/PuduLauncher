name: tauri-build-linux

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build-linux:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      # - name: install dependencies
      #   run: |
      #     sudo apt-get update
      #     # Base build deps.
      #     sudo apt-get install -y \
      #       libwebkit2gtk-4.1-dev \
      #       libjavascriptcoregtk-4.1-dev \
      #       libgtk-3-dev \
      #       libappindicator3-dev \
      #       librsvg2-dev \
      #       patchelf \
      #       clang \
      #       zlib1g-dev

      #     # GitButler-style compatibility pin:
      #     # keep WebKit/JSC/GIR on a known-good toolchain that avoids
      #     # AppImage startup/render issues on Manjaro/SteamOS.
      #     WEBKIT_PREFERRED_VERSION="2.44.3-0ubuntu0.22.04.1"
      #     WEBKIT_VERSION="$WEBKIT_PREFERRED_VERSION"
      #     if ! apt-cache madison libwebkit2gtk-4.1-dev | awk '{print $3}' | grep -Fxq "$WEBKIT_VERSION"; then
      #       # Use the oldest available 4.1 toolchain on this runner.
      #       WEBKIT_VERSION="$(apt-cache madison libwebkit2gtk-4.1-dev | awk '{print $3}' | tail -n1)"
      #     fi

      #     if [ -n "$WEBKIT_VERSION" ]; then
      #       PIN_PACKAGES=()
      #       for pkg in \
      #         libwebkit2gtk-4.1-dev \
      #         libjavascriptcoregtk-4.1-dev \
      #         gir1.2-webkit2-4.1 \
      #         gir1.2-javascriptcoregtk-4.1 \
      #         libwebkit2gtk-4.1-0 \
      #         libjavascriptcoregtk-4.1-0 \
      #         libwebkit2gtk-4.1-0t64 \
      #         libjavascriptcoregtk-4.1-0t64
      #       do
      #         if apt-cache madison "$pkg" | awk '{print $3}' | grep -Fxq "$WEBKIT_VERSION"; then
      #           PIN_PACKAGES+=("${pkg}=${WEBKIT_VERSION}")
      #         fi
      #       done

      #       if [ "${#PIN_PACKAGES[@]}" -gt 0 ]; then
      #         sudo apt-get install -y "${PIN_PACKAGES[@]}"
      #       else
      #         echo "No pin-compatible WebKit/JSC packages found; using repo defaults."
      #       fi
      #     else
      #       echo "No WebKit 4.1 versions available to pin; using repo defaults."
      #     fi

      - uses: ./.github/actions/tauri-build

      - name: upload appimage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: ignore

      - name: upload deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: ignore

      - name: upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: ignore
