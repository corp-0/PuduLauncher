name: tauri-build-linux

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies
        run: |
          sudo apt-get update
          # Newer WebKit builds have caused EGL initialization failures in some AppImage targets (e.g. SteamOS).
          # Prefer the known stable 2.44.3 toolchain when available.
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev=2.44.3-0ubuntu0.22.04.1 \
            libjavascriptcoregtk-4.1-dev=2.44.3-0ubuntu0.22.04.1 \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            clang \
            zlib1g-dev \
          || sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            clang \
            zlib1g-dev

      - uses: ./.github/actions/tauri-build

      - name: upload appimage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: ignore

      - name: upload deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: ignore

      - name: upload rpm
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: ignore
