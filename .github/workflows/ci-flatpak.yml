name: tauri-build-flatpak

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build-flatpak:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies
        run: |
          sudo apt-get update
          # Newer WebKit builds have caused EGL initialization failures in some AppImage targets (e.g. SteamOS).
          # Prefer the known stable 2.44.3 toolchain when available.
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev=2.44.3-0ubuntu0.22.04.1 \
            libjavascriptcoregtk-4.1-dev=2.44.3-0ubuntu0.22.04.1 \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            clang \
            zlib1g-dev \
            flatpak \
            flatpak-builder \
          || sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            clang \
            zlib1g-dev \
            flatpak \
            flatpak-builder

      - name: add flathub remote
        run: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - uses: ./.github/actions/tauri-build

      - name: build flatpak bundle
        run: |
          flatpak-builder \
            --user \
            --force-clean \
            --install-deps-from=flathub \
            flatpak/.flatpak-builder/build \
            flatpak/com.corp0.pudu-launcher.yml
          flatpak build-export flatpak/repo flatpak/.flatpak-builder/build
          flatpak build-bundle flatpak/repo flatpak/com.corp0.pudu-launcher.flatpak com.corp0.pudu-launcher stable

      - name: upload flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: flatpak/com.corp0.pudu-launcher.flatpak
          if-no-files-found: error
