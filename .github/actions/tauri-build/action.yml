name: tauri-build
description: Common Tauri build steps (with truly-portable-appimage support)
runs:
  using: composite
  steps:
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: npm
        cache-dependency-path: package-lock.json

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-v3-${{ hashFiles('src-tauri/Cargo.lock', 'src-tauri/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-cargo-v3-

    - name: Cache NuGet
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src-dotnet/**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Tauri CLI (portable AppImage branch)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        # Only install if not already cached
        if ! cargo tauri --version 2>/dev/null | grep -q "tauri-cli"; then
          cargo install tauri-cli --git https://github.com/tauri-apps/tauri --branch feat/truly-portable-appimage
        fi

    - name: Install frontend dependencies
      run: npm ci
      shell: bash

    - name: Build Tauri
      shell: bash
      env:
        TAURI_BUNDLER_NEW_APPIMAGE_FORMAT: "true"
      run: cargo tauri build
